"0",""
"0","## CLV calc func"
"0","calc_clv <- function(data,"
"0","                     churn_thresh_ui = 0.75,"
"0","                     discount_rate_ui=0.10, "
"0","                     profit_margin_ui=0.10){"
"0",""
"0","  y = rep(0, nrow(data)); y[1:4]"
"0","    a0 = data$recency_days %>% quantile(., probs = churn_thresh_ui); #a0"
"0","    a1 = (data$recency_days >= a0); #a1[1:4]"
"0","    y[a1] = 1; #y[1:8]"
"0","  "
"0","  df0 = data.frame(y=y, "
"0","                       recency0 = data$recency_days,"
"0","                       freq0 = data$transaction_count,"
"0","                       monetary0 = data$amount,"
"0","                       Rscore = data$recency_score,"
"0","                       Fscore=data$frequency_score,"
"0","                       Mscore = data$monetary_score)"
"0",""
"0","  mylogit <- glm(y ~ freq0 + monetary0 + factor(Fscore) + factor(Mscore), "
"0","                 data = df0, family = ""binomial"")  # 0.2s!"
"0",""
"0","  summary(mylogit) # can display if needed"
"0",""
"0","  a2 = mylogit$fitted.values"
"0","  ret_rate = 1 - a2; # ret_rate[1:8]"
"0","  "
"0","  A = ret_rate / (1 + discount_rate_ui - ret_rate); #A[1:8]"
"0","  clv = df0$monetary0 * profit_margin_ui * A; #clv[1:8]"
"0","  "
"0","  df1 = data.frame(df0, CLV=clv); print(head(df1))"
"0","  "
"0","  return(df1) # main output DF for CLV"
"0","  	} # func ends"
"0",""
